ëª¨
---

---
## Project Name: Kubeedge install
#### Date: 2024-01-10 10:22 
#### Tag: #kubeedgeworkflow #kugeedge
##### ref:
---
## Cluster MasterNode install
### keadm binary ì„¤ì¹˜
ğŸ”’ MasterNode, EdgeNode ë‘˜ ë‹¤ ì§„í–‰í•œë‹¤.
```bash
wget https://github.com/kubeedge/kubeedge/releases/download/v1.15.1/keadm-v1.15.1-linux-amd64.tar.gz
tar -xvf 
cp keadm-v1.15.1-linux-amd64/keadm/keadm /usr/local/bin/keadm
```
### cloudcore ì„¤ì¹˜
```bash
keadm init --advertise-address="133.186.251.185" --profile version=v1.15.1 --kube-config=/root/.kube/config 
```
âŒ ì´ init commandë¡œ service ì„¤ì¹˜ê°€ ì•ˆë˜ë”ë¼. 
ì›ë˜ Outputì€ ì•„ë˜ì™€ ê°™ì€ë°,,  ì €ê¸°ì„œ serviceë§Œ ì—†ìŒ
```bash
# kubectl get all -n kubeedge
NAME                             READY   STATUS    RESTARTS   AGE
pod/cloudcore-56b8454784-ngmm8   1/1     Running   0          46s

NAME                TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)                                             AGE
service/cloudcore   ClusterIP   10.96.96.56   <none>        10000/TCP,10001/TCP,10002/TCP,10003/TCP,10004/TCP   46s

NAME                        READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/cloudcore   1/1     1            1           46s

NAME                                   DESIRED   CURRENT   READY   AGE
replicaset.apps/cloudcore-56b8454784   1         1         1       46s
```

ê·¸ë˜ì„œ helm chart  resource êµ¬ì„±ì„ ë³´ì•˜ìŒ  
```bash
keadm manifest generate --advertise-address="133.186.251.185" --profile version=v1.15.1 --kube-config=/root/.kube/config
```
-> ì—¬ê¸°ì—ë„ Serviceê°€ ì—†ì–´

#### ê·¸ë˜ì„œ helmìœ¼ë¡œ ì„¤ì¹˜í•¨
#kugeedgehelm #kugeedgeissue

```bash
git clone https://github.com/kubeedge/kubeedge.git
cd kubeedge/manifest/charts
```

```bash
helm upgrade --install cloudcore ./cloudcore --namespace kubeedge --create-namespace -f ./cloudcore/values.yaml --set cloudCore.modules.cloudHub.advertiseAddress[0]=133.186.251.185
```

```bash
kubectl get svc -A
NAMESPACE        NAME                                 TYPE           CLUSTER-IP      EXTERNAL-IP    PORT(S)                                             AGE
default          kubernetes                           ClusterIP      10.233.0.1      <none>         443/TCP                                             106m
ingress-nginx    ingress-nginx-controller             LoadBalancer   10.233.23.95    172.16.11.82   80:31167/TCP,443:32054/TCP                          101m
ingress-nginx    ingress-nginx-controller-admission   ClusterIP      10.233.9.188    <none>         443/TCP                                             101m
kube-system      coredns                              ClusterIP      10.233.0.3      <none>         53/UDP,53/TCP,9153/TCP                              104m
kube-system      metrics-server                       ClusterIP      10.233.13.205   <none>         443/TCP                                             103m
kubeedge         cloudcore                            ClusterIP      10.233.40.154   <none>         10000/TCP,10001/TCP,10002/TCP,10003/TCP,10004/TCP   6s
metallb-system   webhook-service                      ClusterIP      10.233.49.69    <none>         443/TCP                                             103m
```
ì˜ ë‚˜ì˜¤ë”ë¼..
âŒ ì•ˆë˜ë”ë¼.. ë²„ì „ì´ ì•ˆë§ë“œë¼..ã… 
â•ë²„ì „ ë¬¸ì œëŠ” values.yamlì— cloudcore tagë¥¼. v1.5.1ë¡œ ë°”ê¿”ì¤Œ 

### Edge join
- MasterNode
```bash
keadm gettoken
c6f81aaa3a81390c1e0478e90139d1936c02a7f245069a09a9fe2e1d3347b0b3.eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3MDQ5NDgwNTR9.xhqtRlvD_OB4fnbbxQI4hrYAcddJtEbSxFX45qJ_Etk
```
- EdgeNode
```bash
keadm join --cloudcore-ipport="133.186.251.185":30000 --token=c6f81aaa3a81390c1e0478e90139d1936c02a7f245069a09a9fe2e1d3347b0b3.eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3MDUwMzcyNjV9.hCNu-F0Pm9VLZtfHJni6ehpRIYy1xqpo1Uis3zxCof8 --kubeedge-version=v1.15.1
```
#### issue1: #CRIendpoint CRI v1 image API is not implemented for endpoint "unix:///run/containerd/containerd.sock"
```bash
root@tobeedge:~# keadm join --cloudcore-ipport="133.186.251.185":10000 --token=c6f81aaa3a81390c1e0478e90139d1936c02a7f245069a09a9fe2e1d3347b0b3.eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3MDQ5Mzk4ODF9.1-RMulXJpTxkdUbqPouky16vKVSWheSQ3AIKR0sePwM --kubeedge-version=v1.15.1I0110 11:32:46.909674    3824 command.go:901] 1. Check KubeEdge edgecore process status
I0110 11:32:46.916144    3824 command.go:901] 2. Check if the management directory is clean
I0110 11:32:46.916342    3824 join.go:107] 3. Create the necessary directories
Error: edge node join failed: validate service connection: CRI v1 image API is not implemented for endpoint "unix:///run/containerd/containerd.sock": rpc error: code = Unimplemented desc = unknown service runtime.v1.ImageService
execute keadm command failed:  edge node join failed: validate service connection: CRI v1 image API is not implemented for endpoint "unix:///run/containerd/containerd.sock": rpc error: code = Unimplemented desc = unknown service runtime.v1.ImageService
root@tobeedge:~# Welcome to Ubuntu 22.04.3 LTS (GNU/Linux 5.15.0-86-generic x86_64)
```
~~1. ë²„ì „ì´ ê°™ì•„ì•¼ë§Œ í•œë‹¤.~~
helmìœ¼ë¡œ ì„¤ì¹˜ í–ˆì„ ë•Œ ë²„ì „ì„ ì‹ ê²½ ëª»ì”€ 
Charts.yamlì— 1.12.0ìœ¼ë¡œ ëœ ê²ƒì„ 15.1ë¡œ ë°”ê¿¤ 
![[ìŠ¤í¬ë¦°ìƒ· 2024-01-10 ì˜¤í›„ 1.07.26.png]]
- [/] remote urlì´ container.dë¡œ default ì¡í˜€ìˆë‹¤ ì´ë¶€ë¶„ì„ ë³€ê²½í•´ì¤˜
- í˜„ì¬ ìš°ë¦¬ í”Œë«í¼ì—ì„œ ì“°ëŠ” runtimeì€ CRI-Oì´ë‹¤
- Master nodeì—ì„œ `ps -ef | grep crio` ë¥¼ ì‹¤í–‰ í›„ sockì˜ ìœ„ì¹˜ë¥¼ ì°¾ëŠ”ë‹¤
```bash
--container-runtime-endpoint=unix:///var/run/crio/crio.sock
```
3. commandì— remote urlì„ ì§€ì • í›„ ì‹¤í–‰í•œë‹¤
```bash
keadm join --cloudcore-ipport="133.186.251.185":30000 --token=--token=c6f81aaa3a81390c1e0478e90139d1936c02a7f245069a09a9fe2e1d3347b0b3.eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3MDUwMzcyNjV9.hCNu-F0Pm9VLZtfHJni6ehpRIYy1xqpo1Uis3zxCof8 --kubeedge-version=v1.15.1 --remote-runtime-endpoint=unix:///var/run/crio/crio.sock
```

#### issue2: #nosuchfile no such file or directory (crio)
```bash
I0110 14:24:53.213112    4378 command.go:901] 1. Check KubeEdge edgecore process status
I0110 14:24:53.218396    4378 command.go:901] 2. Check if the management directory is clean
I0110 14:24:53.218441    4378 join.go:107] 3. Create the necessary directories
I0110 14:24:53.219092    4378 join.go:184] 4. Pull Images
Pulling docker.io/kubeedge/installation-package:v1.15.1 ...
E0110 14:24:53.219135    4378 remote_image.go:140] "Get ImageStatus from image service failed" err="rpc error: code = Unavailable desc = connection error: desc = \"transport: Error while dialing dial unix /var/run/crio/crio.sock: connect: no such file or directory\"" image="docker.io/kubeedge/installation-package:v1.15.1"
Error: edge node join failed: pull Images failed: rpc error: code = Unavailable desc = connection error: desc = "transport: Error while dialing dial unix /var/run/crio/crio.sock: connect: no such file or directory"
execute keadm command failed:  edge node join failed: pull Images failed: rpc error: code = Unavailable desc = connection error: desc = "transport: Error while dialing dial unix /var/run/crio/crio.sock: connect: no such file or directory"
```
##### ref:
[crio.confë°”ê¿”ì£¼ê¸°](https://github.com/kubeedge/kubeedge/issues/5139)
[default conf](https://github.com/cri-o/cri-o/blob/main/docs/crio.conf.5.md)

1. remote urlì„ ë³€ê²½í•´ì£¼ì—ˆëŠ”ë° installation-packageì— ì—†ë‹¤ëŠ”ë””;
2. run
```bash
keadm join --cloudcore-ipport="133.186.251.185:10000" --token=c6f81aaa3a81390c1e0478e90139d1936c02a7f245069a09a9fe2e1d3347b0b3.eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3MDQ5NDgwNTR9.xhqtRlvD_OB4fnbbxQI4hrYAcddJtEbSxFX45qJ_Etk --kubeedge-version=v1.15.1 --remote-runtime-endpoint=unix:///var/run/crio/crio.sock
```

### í•´ê²°:ì€ ì•„ë‹ˆì§€ë§Œ ì„ ì²˜ë¦¬ í•´ì•¼ë ê²ƒì´.... gã…í•˜í•˜í•³ã…ã…ã…ã…ã…ã…ã…ã…ã…ã…ã…ã… 
1. crioë„ Edgeì— ì„¤ì¹˜ ë˜ì–´ì•¼í•¨. #kugeedgeìˆœì„œ
3. cloudcore service ë…¸ì¶œ ì‹œí‚¤ê¸° 
#### cri-o ì„¤ì¹˜
##### Ref
1. [Cri-o github](https://github.com/cri-o/cri-o/blob/main/install.md#debian-bullseye-or-higher---ubuntu-2004-or-higher)
2. [cri-o docs](https://cri-o.io/)

```bash
cat <<EOF | sudo tee /etc/modules-load.d/crio.conf
overlay
br_netfilter
EOF
```
```bash
sudo modprobe overlay
sudo modprobe br_netfilter
````
```bash
cat <<EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf
net.bridge.bridge-nf-call-iptables  = 1
net.ipv4.ip_forward                 = 1
net.bridge.bridge-nf-call-ip6tables = 1
EOF
```
```bash
sudo sysctl --system
```

```bash
sudo -i
```
```bash
export OS=xUbuntu_22.04
export VERSION=1.27.1
```
```bash
echo "deb https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable:/cri-o:/1.27:/1.27.1/xUbuntu_22.04/ /" > /etc/apt/sources.list.d/devel:kubic:libcontainers:stable.list
```
```bash
echo "deb http://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable:/cri-o:/$VERSION/$OS/ /" > /etc/apt/sources.list.d/devel:kubic:libcontainers:stable:cri-o:$VERSION.list
```
```bash
curl -L https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable:/cri-o:/$VERSION/$OS/Release.key | apt-key add -
```
```bash
curl -L https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/$OS/Release.key | apt-key add -
```
```bash
sudo apt-get update
```
```bash
sudo apt-get -y install cri-o cri-o-runc cri-tools
```
```bash
sudo systemctl daemon-reload
sudo systemctl enable crio --now

```

```bash
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0Warning: apt-key is deprecated. Manage keyring files in trusted.gpg.d instead (see apt-key(8)).
100  1083    0  1083    0     0   1275      0 --:--:-- --:--:-- --:--:--  1274
gpg: no valid OpenPGP data found.
```
*ê³§ì£½ì–´ë„ ì•ˆë˜ëŠ”ê±°ì•¼ ..... curlì´..* 

- í•´ë‹¹ urlì„ ë“¤ì–´ê°€ë´¤ë”ë‹ˆ ê°ì²´ê°€ ì—†ì–´ì¡ŒëŒ€. ê·¸ë˜ì„œ ê²½ë¡œë¥¼ ë‹¤ì‹œ ì°¾ì•„ì¤Œ 
![[ìŠ¤í¬ë¦°ìƒ· 2024-01-10 ì˜¤í›„ 4.44.33.png]]

- ì°¾ì•„ì¤€ í›„ commandëŠ” ì•„ë˜ì™€ ê°™ì•„ 
![[ìŠ¤í¬ë¦°ìƒ· 2024-01-10 ì˜¤í›„ 4.48.02.png]]
```bash
curl -L https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable:/cri-o:/1.27:/1.27.1/xUbuntu_22.04/Release.key | apt-key add -
```

- ì–´ì°Œì–´ì°Œ apt-get updateë„ ì•ˆë˜ê³  í–ˆì§€ë§Œ ..  ì´ì „ì— ë“±ë¡ëœ 1.27ì˜ ì˜ëª»ëœ ê²½ë¡œì˜ source listê°€ ë“±ë¡ë¼ ìˆì—ˆê¸° ë•Œë¬¸.. ì–´ì°Œì €ì°Œ updateê¹Œì§€ ëŠ” í•´ê²°í–ˆë‹¤ê³  í•œë‹¤.  ê·¸ëŸ¬ë‚˜ ì•„ë˜ commandë¶€í„° ë˜ ë§‰í˜..
![[ìŠ¤í¬ë¦°ìƒ· 2024-01-10 ì˜¤í›„ 4.47.03.png]]
- githubì— ë“¤ì–´ê°”ë”ë‹ˆ ubuntu 22.04 ì´ìƒì— í•„ìš”í•œ ìŠ¤í¬ë¦½íŠ¸ê°€ ìˆë‹¤ 
apt-get update -qq && apt-get install -y \
  libbtrfs-dev \
  containers-common \
  git \
  libassuan-dev \
  libdevmapper-dev \
  libglib2.0-dev \
  libc6-dev \
  libgpgme-dev \
  libgpg-error-dev \
  libseccomp-dev \
  libsystemd-dev \
  libselinux1-dev \
  pkg-config \
  go-md2man \
  cri-o-runc \
  libudev-dev \
  software-properties-common \
  gcc \
  make

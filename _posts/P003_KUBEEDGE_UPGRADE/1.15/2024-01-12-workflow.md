---

---
## Project Name: 
#### Date: 2024-01-12 09:04 
#### Tag: #kugeedge_nginx
##### ref:
---
## *ê·¸ëŸ°ë°,,ë‚˜ëŠ” ì§€ê¸ˆê¹Œì§€ daemonìœ¼ë¡œ ë– ìˆëŠ”ì¤„ ì•Œê³  `keadm` ëª…ë ¹ì–´ë¥¼ ì“°ê³  ë¡œì»¬ì˜ `/etc/kubeedge/config` ì—ì„œ í¸ì§‘í•˜ê³  ì‘ì—…í•˜ê³  ,,,, ê·¸ëŸ°ë° `kubeedge` ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— Podë¡œ ë– ìˆìŒ ..ã…  ê·¸ë˜ì„œ ì„¤ì •ê°’ì´ë‚˜ ì´ëŸ° ì§„í–‰ë“¤ì´ ë‹¤ podë¡œ ì´ë£¨ì–´ì ¸ì•¼í•˜ê³   `Configmap` ìˆ˜ì •ì„ í•´ì•¼í•¨.. ë‚´ê°€ ì§„í–‰í•œ ëŒ€ë¡œ í•˜ë©´ ë˜ê¸´ í•œë”” ... ^^ ëª°í•œê±°ì§€ (2024/01/12 15ì‹œ52ë¶„..) 

## Nginx test
- *MasterNode* Nginx ë°°í¬
```bash
NAME                                       READY   STATUS              RESTARTS      AGE
pod/nfs-pod-provisioner-6d7bb66d56-bmgnv   1/1     Running             3 (47h ago)   47h
pod/nginx-deployment-67884b469c-6thj4      0/1     ContainerCreating   0             16h

NAME                    TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
service/kubernetes      ClusterIP   10.233.0.1      <none>        443/TCP        47h
service/nginx-service   NodePort    10.233.44.103   <none>        80:31113/TCP   16h

NAME                                  READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/nfs-pod-provisioner   1/1     1            1           47h
deployment.apps/nginx-deployment      0/1     1            0           16h

NAME                                             DESIRED   CURRENT   READY   AGE
replicaset.apps/nfs-pod-provisioner-6d7bb66d56   1         1         1       47h
replicaset.apps/nginx-deployment-67884b469c      1         1         0       16h
```
### issue 1: Nginx ìƒíƒœê°€ ContainerCreatingì— ë¨¸ë¬¼ëŸ¬ ìˆìŒ
> *MasterNode*Â ì—ì„œ Kubeproxy, nginx pod log
```bash
Error from server: Get "https://172.16.11.79:10350/containerLogs/default/nginx-deployment-67884b469c-6thj4/nginx?follow=true": dial tcp 172.16.11.79:10350: connect: connection refused
```

> *EdgeNode* edgecore log
```bash
"Error syncing pod, skipping" err="failed to \"CreatePodSandbox\" for \"nginx-depl
oyment-67884b469c-6thj4_default(83566754-e11e-428e-99d0-4616013a404c)\" with CreatePodSandboxError: \"Failed to create sandbox for pod \\\"nginx-deployment-67884b469c-6th
j4_default(83566754-e11e-428e-99d0-4616013a404c)\\\": rpc error: code = Unknown desc = cri-o configured with systemd cgroup manager, but did not receive slice as parent:
/kubepods/besteffort/pod83566754-e11e-428e-99d0-4616013a404c\"" pod="default/nginx-deployment-67884b469c-6thj4" podUID=83566754-e11e-428e-99d0-4616013a404c
```

> *MasterNode* Nginx ìƒíƒœ: ContainerCreatingì— ë¨¸ë¬¼ëŸ¬ ìˆìŒ.
```bash
NAME                                       READY   STATUS              RESTARTS      AGE
pod/nfs-pod-provisioner-6d7bb66d56-bmgnv   1/1     Running             3 (47h ago)   47h
pod/nginx-deployment-67884b469c-6thj4      0/1     ContainerCreating   0             16h

NAME                    TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
service/kubernetes      ClusterIP   10.233.0.1      <none>        443/TCP        47h
service/nginx-service   NodePort    10.233.44.103   <none>        80:31113/TCP   16h

NAME                                  READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/nfs-pod-provisioner   1/1     1            1           47h
deployment.apps/nginx-deployment      0/1     1            0           16h

NAME                                             DESIRED   CURRENT   READY   AGE
replicaset.apps/nfs-pod-provisioner-6d7bb66d56   1         1         1       47h
replicaset.apps/nginx-deployment-67884b469c      1         1         0       16h
```

#### Do
1.  config ì„¤ì •ê°’ ë³€ê²½
    1. *EdgeNode* crio.conf
        1. `cgroup_manager = "systemd"` ì£¼ì„ í•´ì œ
    2. *MasterNode* `/var/lib/kubelet/kubeadm-flags.env`
        1. `--cgroup-manager=systemd`Â ì¶”ê°€
    - ref
        - [configì„¤ì •](https://stackoverflow.com/questions/62408028/kubelet-failed-to-createpodsandbox-for-coredns-failed-to-set-bridge-addr-c)
        - [crio default podnetwork](https://github.com/cri-o/cri-o/blob/main/tutorials/kubeadm.md)
    ![[ìŠ¤í¬ë¦°ìƒ· 2024-01-12 ì˜¤ì „ 11.15.01.png]]

2. Â ~~*masternode* `/etc/cniÃ¸net.d/87-podman-bridge.conflist` ìˆ˜ì •~~ 
    - ref
        - [cni configure](https://www.airplane.dev/blog/troubleshooting-failed-to-create-pod-sandbox-error)
-  `bridge` ë¥¼ `bridg`, `cni-poman0`ì„ `cni-poman`ìœ¼ë¡œ ë³€ê²½ 
    ![[ìŠ¤í¬ë¦°ìƒ· 2024-01-12 ì˜¤í›„ 1.28.42.png]]
- runningìƒíƒœê°€ ëœ¨ê¸´ í•¨..  (ë¬´ìŠ¨ ìƒê´€ì´ì§€ )  **ğŸ“Œ SOLVED**
    ![[ìŠ¤í¬ë¦°ìƒ· 2024-01-12 ì˜¤í›„ 1.34.47.png]]

3. *MasterNode* *EdgeNode* config yamlíŒŒì¼ ì„¤ì •ê°’ ë³€ê²½
> ê·¼ë° ìš”ê±°ëŠ” EdgeNodeì—ì„œ ë¡œê·¸ë¥¼ ë³¼ ìˆ˜ ì—†ëŠ”ë° ë¡œê·¸ë¥¼ ë³´ê³  ì‹¶ìœ¼ë©´ `kubectl logs` ë¥¼ ì“¸ ìˆ˜ ìˆê²Œ  ì§„í–‰ í•˜ëŠ” ì ˆì°¨ì„. ì•ˆí•´ë„ ë¬´ë°©í•˜ë‹¤!
- `$ export CLOUDCOREIPS="133.186.251.185"`
- `$ iptables -t nat -A OUTPUT -p tcp --dport 10350 -j DNAT --to $CLOUDCOREIPS:30003`
- ê° config yamlì˜ `cloudStream`, `edgeStream`ì„ `enable: true`ë¡œ ë°”ê¿”ì¤Œ
    ![[ìŠ¤í¬ë¦°ìƒ· 2024-01-12 ì˜¤í›„ 2.00.30.png]]
    ![[ìŠ¤í¬ë¦°ìƒ· 2024-01-12 ì˜¤í›„ 2.01.15.png]]

### issue 2: edgemeshë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” kube-proxyë¥¼ ì“°ì§€ ì•ŠëŠ”ë‹¤?
ref: chrome-extension://efaidnbmnnnibpcajpcglclefindmkaj/https://readthedocs.org/projects/kubeedge/downloads/pdf/latest/
#### í•´ê²°
- *MasterNode* kube-proxy daemonsetì— ì•„ë˜ë¥¼ ì¶”ê°€
> spec.affinty
```yaml
affinity: 
  nodeAffinity: 
    requiredDuringSchedulingIgnoredDuringExecution: 
      nodeSelectorTerms:
      - matchExpressions:
        - key: node-role.kubernetes.io/edge 
          operator: DoesNotExist
```
- *EdgeNode* edgecore.serviceì—ì„œ proxy ê´€ë ¨ì€ ì—ëŸ¬ê°€ ì—†ì–´ì¡ŒìŒ. 

## Nginx issue í•´ê²° í›„ í†µì‹  ì²´í¬

1. Curl pod ë°°í¬ 
- [[Curl test Pod]]
    ğŸ¥² ì§„ì§œ ì›ƒê¹€.. ë‚˜ëŠ” ì´ íŒŒë“œê°€ ìê¾¸ ì™œ edgeì— ë°°í¬ë˜ëŠ”ì§€ ê¶ê¸ˆí•´ì„œ Doì˜ 2ë²ˆ ì‘ì—…ì„ í•´ì£¼ì—ˆë˜ ê²ƒì¸ë°.... ã…‹ edgeë„ í´ëŸ¬ìŠ¤í„°ì¤‘ í•˜ë‚˜ì˜ ë…¸ë“œì´ë‹ˆê¹Œ ë‹¹ì—°íˆ ë°°í¬ë  ìˆ˜ ìˆìë„ˆ..? ë°”ë³´ë‹¤.. ã…‹ 
    ![[ìŠ¤í¬ë¦°ìƒ· 2024-01-12 ì˜¤í›„ 2.27.37.png]]
    ![[ìŠ¤í¬ë¦°ìƒ· 2024-01-12 ì˜¤í›„ 2.29.49.png]]
    ì•„ë¬´íŠ¼ ê·¸ë˜ì„œ  curl podë¥¼ nodeselectorë¡œ ì§€ì •í•˜ì—¬ Edgeì— ë°°í¬ ì•ˆë˜ê²Œ ë‹¤ì‹œ ì¬ë°°í¬ ê³ ê³ .
- ë°°í¬: ë  ë¦¬ê°€ ì—†ì¥¬
    ![[ìŠ¤í¬ë¦°ìƒ· 2024-01-12 ì˜¤í›„ 2.58.15.png]]

## ì´ì œëŠ” EdgeMesh í•  ì°¨ë¡€
> ìœ„ì™€ ê´€ë ¨í•˜ì—¬ Pod ì•ˆì—ì„œë„ í†µì‹ ì„ í•  ìˆ˜ ìˆê²Œ  'edgeMesh'ë¥¼ ì§„í–‰í•˜ê²Œ ëœë‹¤ 

kubectl taint nodes --all node-role.kubernetes.io/control-plane
```
kubectl label services kubernetes service.edgemesh.kubeedge.io/service-proxy-name="edgemesh"
```


```
keadm init --advertise-address="133.186.251.185" --profile version=v1.15.1 --kube-config=/root/.kube/config --set cloudCore.modules.dynamicController.enable=true
```
133.186.212.168
### Podë¡œ ê°‘ìê¸° ì§„í–‰í•˜ê¸°
- Cloudcoreì˜ configmap
```yaml
apiVersion: v1
data:
  cloudcore.yaml: "apiVersion: cloudcore.config.kubeedge.io/v1alpha2\nkind: CloudCore\nkubeAPIConfig:\n
    \ kubeConfig: \"\"\n  master: \"\"\nmodules:\n  cloudHub:\n    advertiseAddress:\n
    \   - 133.186.251.185\n    dnsNames:\n    - \n    nodeLimit: 1000\n    tlsCAFile:
    /etc/kubeedge/ca/rootCA.crt\n    tlsCertFile: /etc/kubeedge/certs/edge.crt\n    tlsPrivateKeyFile:
    /etc/kubeedge/certs/edge.key\n    unixsocket:\n      address: unix:///var/lib/kubeedge/kubeedge.sock\n
    \     enable: true\n    websocket:\n      address: 0.0.0.0\n      enable: true\n
    \     port: 30000\n    quic:\n      address: 0.0.0.0\n      enable: false\n      maxIncomingStreams:
    10000\n      port: 30001\n    https:\n      address: 0.0.0.0\n      enable: true\n
    \     port: 30002\n  cloudStream:\n    enable: true\n    streamPort: 30003\n    tunnelPort:
    10004\n  dynamicController:\n    enable: true\n  router:\n    enable: false\n
    \ iptablesManager:\n    enable: true\n    mode: internal\n  nodeUpgradeJobController:\n
    \   enable: false\n"
kind: ConfigMap
metadata:
  annotations:
    meta.helm.sh/release-name: cloudcore
    meta.helm.sh/release-namespace: kubeedge
  creationTimestamp: "2024-01-11T05:27:33Z"
  labels:
    app.kubernetes.io/managed-by: Helm
    k8s-app: kubeedge
    kubeedge: cloudcore
  name: cloudcore
  namespace: kubeedge
  resourceVersion: "443867"
  uid: 34be17b8-9906-46bf-98cf-12759c9ae3fb
```
- ìˆ˜ì • í›„ ì§„í–‰
```bash
kubectl rollout restart deploy cloudcore
```
- ë³´ê¸° ì–´ë ¤ì›Œì„œ Yamlë¡œ ë°”ê¿”ì„œ ëˆˆì— ë³´ì´ê¸° ì‰½ê²Œ í•´ë´„ 
```yaml
cloudcore.yaml: |
  apiVersion: cloudcore.config.kubeedge.io/v1alpha2
  kind: CloudCore
  kubeAPIConfig:
    kubeConfig: "/root/.kube/config"
    master: ""
  modules:
    cloudHub:
      advertiseAddress:
        - 133.186.251.185
      dnsNames:
        - 
      nodeLimit: 1000
      tlsCAFile: /etc/kubeedge/ca/rootCA.crt
      tlsCertFile: /etc/kubeedge/certs/edge.crt
      tlsPrivateKeyFile: /etc/kubeedge/certs/edge.key
      unixsocket:
        address: unix:///var/lib/kubeedge/kubeedge.sock
        enable: true
      websocket:
        address: 0.0.0.0
        enable: true
        port: 30000
      quic:
        address: 0.0.0.0
        enable: false
        maxIncomingStreams: 10000
        port: 30001
      https:
        address: 0.0.0.0
        enable: true
        port: 30002
    cloudStream:
      enable: true
      streamPort: 30003
      tunnelPort: 30004
    dynamicController:
      enable: true
    router:
      enable: false
    iptablesManager:
      enable: true
      mode: internal
    nodeUpgradeJobController:
      enable: false
```
---
title: Edit Script
author: bami jeong
categories:
  - Kubeedge
tags:
  - result
  - Kubeedge
  - Migration
category: kubeedge
---


# Version

1. keadm
```bash
$ keadm version -o yaml
buildDate: "2023-11-30T13:18:28Z"
compiler: gc
gitCommit: 6ed117e14e91f5799739f196056cc6163f7c8e9b
gitTreeState: clean
gitVersion: v1.14.4
goVersion: go1.17.13
major: "1"
minor: "14"
platform: linux/amd64
```

2. kubeedge
```yaml
     containers:
      - image: kubeedge/cloudcore:v1.14.4
        imagePullPolicy: IfNotPresent
        name: cloudcore
        ports:
```

3. cri-o
```bash
Version:  0.1.0
RuntimeName:  cri-o
RuntimeVersion:  1.24.1
RuntimeApiVersion:  v1alpha2
```

# /roles/cp/edge/
## cri_install

```yaml
---
- name: get home dir path
  become: false
  shell: "echo $HOME"
  register: home_dir_path

- name: cri-o download
  shell: |
    wget https://storage.googleapis.com/cri-o/artifacts/cri-o.amd64.v1.24.1.tar.gz
    tar zxvf cri-o.amd64.v1.24.1.tar.gz
    cd cri-o
    ./install

- name: remove cri-o tar file
  file:
    path: "{{ home_dir_path.stdout }}/cri-o.amd64.v1.24.1.tar.gz"
    state: absent

- name: remove cri-o dir
  file:
    path: "{{ home_dir_path.stdout }}/cri-o"
    state: absent

- name: enable crio.service
  shell: |
    echo unqualified-search-registries = [\"docker.io\", \"quay.io\"] > /etc/containers/registries.conf
    sed -i 's/,metacopy=on//g' /etc/containers/storage.conf
    systemctl daemon-reload
    systemctl enable crio.service
    systemctl start crio.service
  ignore_errors: true
```

## edgecore

```yaml
---
- name: install mosquitto
  shell: |
    apt-get install -y mosquitto

- name: modify edgecore
  shell: |
    sed -i '164s/false/true/g' /etc/kubeedge/config/edgecore.yaml
    sed -i 's@remoteImageEndpoint: unix:///var/run/dockershim.sock@remoteImageEndpoint: unix:///var/run/crio/crio.sock@g' /etc/kubeedge/config/edgecore.yaml
    sed -i 's@remoteRuntimeEndpoint: unix:///var/run/dockershim.sock@remoteRuntimeEndpoint: unix:////var/run/crio/crio.sock@g' /etc/kubeedge/config/edgecore.yaml
    sed -i 's@podSandboxImage: kubeedge/pause:3.1@podSandboxImage: k8s.gcr.io/pause:3.6@g' /etc/kubeedge/config/edgecore.yaml
    sed -i 's/containerRuntime: docker/containerRuntime: remote/g' /etc/kubeedge/config/edgecore.yaml
    sed -i 's/cgroupDriver: cgroupfs/cgroupDriver: systemd/g' /etc/kubeedge/config/edgecore.yaml
    sed -i 's/:10000/:30000/g' /etc/kubeedge/config/edgecore.yaml
    sed -i 's/:10001/:30001/g' /etc/kubeedge/config/edgecore.yaml
    sed -i 's/:10002/:30002/g' /etc/kubeedge/config/edgecore.yaml
    sed -i 's/:10004/:30004/g' /etc/kubeedge/config/edgecore.yaml

- name: restart edgecore
  shell: |
    systemctl daemon-reload
    systemctl restart edgecore.service
```

## edgemesh

```yaml
---
- name: get home dir path
  become: false
  shell: "echo $HOME"
  register: home_dir_path

- name: Remove the taint of the K8s master nodes
  shell: "kubectl taint nodes --all node-role.kubernetes.io/master-"
  ignore_errors: true

- name: Add filter labels to Kubernetes API services
  shell: "kubectl label services kubernetes service.edgemesh.kubeedge.io/service-proxy-name=\"\""

- name: apply edgemesh crds
  shell: "kubectl apply -f {{ home_dir_path.stdout }}/cp-deployment/edge/edgemesh/crds/istio"

- name: apply edgemesh server
  shell: "kubectl apply -f {{ home_dir_path.stdout }}/cp-deployment/edge/edgemesh/agent/"
```

## keadm_amd64

```yaml
---
- name: get home dir path
  become: false
  shell: "echo $HOME"
  register: home_dir_path

- name: copy keadm (amd64)
  copy:
    src: "{{ home_dir_path.stdout }}/cp-deployment/edge/keadm/amd64/keadm"
    dest: "/usr/bin/keadm"
    mode: 0755
```

## keadm_init

```yaml
---
- name: get home dir path
  become: false
  shell: "echo $HOME"
  register: home_dir_path

- name: change kube-proxy config
  shell: |
    kubectl patch daemonset kube-proxy -n kube-system --patch-file {{ home_dir_path.stdout }}/cp-deployment/edge/ha-cloudcore/kube-proxy.yaml

- name: add cloudcore node label
  shell: |
    kubectl label nodes {{ cloudcore1_node_hostname }} kubeedge-cloudcore=cloudcore-node
    kubectl label nodes {{ cloudcore2_node_hostname }} kubeedge-cloudcore=cloudcore-node
  ignore_errors: true

- name: deploy ha cloudcore
  shell: |
    kubectl apply -f {{ home_dir_path.stdout }}/cp-deployment/edge/ha-cloudcore/01-ha-prepare.yaml
    kubectl apply -f {{ home_dir_path.stdout }}/cp-deployment/edge/ha-cloudcore/02-ha-configmap.yaml
    kubectl apply -f {{ home_dir_path.stdout }}/cp-deployment/edge/ha-cloudcore/03-ha-deployment.yaml

- name: Pause keadm init
  pause:
    minutes: 1

- name: create keadm token file
  shell: keadm gettoken > keadm_token

- name: deploy kubeedge crd
  shell: |
    kubectl apply -f https://raw.githubusercontent.com/kubeedge/kubeedge/master/build/crds/router/router_v1_ruleEndpoint.yaml
    kubectl apply -f https://raw.githubusercontent.com/kubeedge/kubeedge/master/build/crds/router/router_v1_rule.yaml
    kubectl apply -f https://raw.githubusercontent.com/kubeedge/kubeedge/master/build/crds/apps/apps_v1alpha1_edgeapplication.yaml
    kubectl apply -f https://raw.githubusercontent.com/kubeedge/kubeedge/master/build/crds/apps/apps_v1alpha1_nodegroup.yaml
    kubectl apply -f https://raw.githubusercontent.com/kubeedge/kubeedge/master/build/crds/operations/operations_v1alpha1_nodeupgradejob.yaml
```

## keadm_join

```yaml
---
- name: get home dir path
  become: false
  shell: "echo $HOME"
  register: home_dir_path

- name: copy keadm token file
  copy:
    src: "{{ home_dir_path.stdout }}/keadm_token"
    dest: "{{ home_dir_path.stdout }}"

- name: get keadm token
  shell: "echo $(<{{ home_dir_path.stdout }}/keadm_token)"
  register: keadm_token
  args:
    executable: /bin/bash

- name: keadm join
  shell: "nohup keadm join --cloudcore-ipport={{ cloudcore_vip }}:30000 --token={{ keadm_token.stdout }} --kubeedge-version=v1.14.4 --with-mqtt=false --remote-runtime-endpoint=unix:///var/run/crio/crio.sock"

- name: remove keadm token file
  file:
    path: "{{ home_dir_path.stdout }}/keadm_token"
    state: absent

- name: modify edgecore
  lineinfile:
    path: /etc/kubeedge/config/edgecore.yaml
    insertafter: "tailoredKubeletConfig:"
    line: "{{ item }}"
  with_items:
    - "      clusterDomain: cluster.local"
    - "        - {{ cloudcore_vip }}"
    - "      clusterDNS:"
```

